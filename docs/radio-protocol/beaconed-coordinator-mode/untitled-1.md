# 802.15.4 implementation

The 802.15.4 interface is based on the IEEE 802.15.4-2003 wireless personal area network specification. When the host starts a network, it specifies a radio channel number, a beacon order value, and a bit rate. The base station selects a random PAN ID, sets its own 16-bit address to 0x0100, and begins broadcasting beacons in conformance with IEEE 802.15.4-2003. The beacons shall exhibit a Battery Life Extension setting of 0, a PAN Coordinator setting of 1, and an Association Permit setting of 1 if and only if the access control bitmask is nonzero.

Each robot shall exist in one of the following states: DISASSOCIATED, ASSOCIATED, DISASSOCIATE-FAST, or DISASSOCIATE-SLOW. When reporting an association bitmask, DISASSOCIATED is considered not associated, while the other three states are all considered associated.

Association is handled using a slight modification to the IEEE 802.15.4-specified procedures. The usual Association Request and Association Response MAC command frames are used, but direct transmission of Association Response frames is used in place of indirect transmission because the robots keep their receivers powered at all times. The capability information field in an Association Request frame shall indicate that the robot is a full-function device, that its receiver remains on when idle, and that it requires a 16-bit address. The contents of the Association Response frame shall be determined as follows; unless otherwise specified, only the first matching rule shall apply:

* If the pattern number derived from the 64-bit address in the Association Request corresponds to a bit in the access control bitmask with value 0, the Association Response frame shall indicate PAN Access Denied and the robot shall continue scanning for other hosts.
* If the 64-bit address in the Association Request frame is equal to the 64-bit address of a robot currently in the ASSOCIATED state, the Association Response frame shall indicate Association Successful and shall grant the robot its current 16-bit address.
* If the pattern number derived from the 64-bit address in the Association Request frame matches the pattern number of a robot currently in the ASSOCIATED state, the Association Response shall indicate PAN At Capacity and the robot shall retry the request shortly, and the host shall initiate disassociation of the already-associated robot.
* If the 64-bit address in the Association Request frame is equal to the 64-bit address of a robot currently in the DISASSOCIATE-FAST or DISASSOCIATE-SLOW state, the state shall be changed to DISASSOCIATE-FAST, the Association Response frame shall indicate PAN At Capacity, and the robot shall retry the request shortly.
* The robot shall be allocated an unused 16-bit address, the robot shall be moved into the ASSOCIATED state, and the Association Response frame shall indicate Association Successful.

Disassociation initiated by the host is handled using a slight modification to the IEEE 802.15.4-specified procedures. The usual Disassociation Notification MAC command frame is used, but direct transmission is used in place of indirect transmission because the robots keep their receivers powered at all times. Should the host decide it wishes a robot to disassociate, it shall move the robot to the DISASSOCIATE-SLOW state.

Disassociation initiated by the robot shall occur as follows. The robot shall first arrange that no further data or command frames from the host shall be acknowledged, and shall then send a Disassociation Notification frame; it shall request acknowledgement for the frame and shall retransmit the usual number of times provided by the MAC, but shall ignore the eventual success or failure of delivery. When the host receives the Disassociation Notification frame, it shall move the robot to the DISASSOCIATE-FAST state.

A robot in the DISASSOCIATE-SLOW state shall be sent Disassociate Notification frames on a regular basis and shall remain in that state until either one such frame is acknowledged \(at which time the robot shall transition to DISASSOCIATE-FAST\) or until DISASSOCIATE\_SLOW\_MAX\_BEACONS beacons have occurred \(at which time the robot shall transition to DISASSOCIATED\). A robot in the DISASSOCIATE-FAST state shall not be sent any packets and shall remain in that state until DISASSOCIATE\_FAST\_MAX\_BEACONS beacons have been transmitted and shall then transition to the DISASSOCIATED state. In both the DISASSOCIATE-SLOW and DISASSOCIATE-FAST states, in packets shall be accepted by the host and delivered to the application as usual.

A robot that initiates disassociation shall make the usual number of delivery attempts provided by the MAC for its Disassociation Notification frame, and once the frame is acknowledged or the delivery attempts have all failed, shall proceed to post-disassociation procedures. A robot that receives a Disassociation Notification frame from the host shall continue receiving on the channel for DISASSOCIATE\_DUP\_WAIT\_TIME milliseconds, acknowledging any additional duplicate Disassociation Notification frames, and shall then proceed to post-disassociation procedures. In both cases, the robot is permitted to begin making itself safe during the disassociation procedure.

Once a robot enters post-disassociation procedures, further activity depends on the reason for disassociation. In the event that the robot was requested to shut down by the host or that the robot’s logic determined that it must shut down, the robot shall shut down. In any other case, the robot shall proceed with a pre-association channel scan and shall begin attempting to associate to networks.

The IEEE 802.15.4-specified PAN ID conflict detection and notification mechanism shall be used. Data Request frames shall not be used; all outbound frames shall be delivered directly and robots shall keep their receivers on at all times, the Frame Pending bit shall never be set, and any Data Request received by a host shall be ignored. Orphan Notification frames shall not be used; a robot which fails to receive aMaxLostBeacons consecutive beacons shall initiate the logical equivalent of a graceful reboot. Beacon Request frames shall not be used; the beacon order for hosts shall be less than 15 \(indicating a beacon-enabled network\) and robots shall always use passive scans to find hosts. GTS Request frames shall not be used; the GTSs in the superframe shall be allocated by the host as needed for each superframe as described in the individual delivery classes.

HF-Out messages shall be sent by packing the messages for all associated robots into the beacon payload. The beacon payload shall comprise a four-byte signature \(the bytes 0x7B, 0x07, 0x50, 0xFC, approximately “TBOTS FC”\), a one-byte payload sequence number \(PSN\) which is initialized to a random value at system startup and incremented each time the USB interface delivers a new set of HF-Out messages, followed by a block of MAX\_ASSOC HF-Out messages, each one HF\_OUT\_LEN bytes long. A robot’s subpacket index \(equal to its 16-bit address\) determines which message in the array it examines. On receiving each beacon, the robot shall first compare the PSN in the received beacon to the last PSN seen; if they are unequal, the robot shall receive the HF-Out message in the corresponding location. The usual MAC-layer rules about failing to receive aMaxLostBeacons consecutive beacons shall apply; should this occur, the robot shall initiate disassociation procedures.

LL-Out messages shall be sent as ordinary direct data frames in the contention access period, addressed to the robot’s 16-bit address. These frames’ Acknowledgement Request bits shall be set. In the face of errors, the host shall retry transmission up to LL\_OUT\_RETRIES times \(with these retries shared between MAC-layer retries and network-layer retries, in all cases keeping the same packet sequence number\). The robot shall consider an LL-Out message as received if it sees a frame whose sequence number is not equal to the last sequence number it observed in the current epoch. If an acknowledgement is received, the host shall report that the message was received; should LL\_OUT\_RETRIES retries all fail, the host shall report that the message could not be delivered and, furthermore, shall immediately start disassociation procedures for the robot.

HF-In messages shall be sent as ordinary direct data frames in the contention free period, during a superframe in which the host has chosen to allocate a GTS to the robot. The host shall always allocate one GTS per superframe and shall allocate it in turn to each associated robot. The Acknowledgement Request bit shall be set. The robot shall report the transmission as successful or failed based on the MAC layer’s status; no extra retransmissions shall be performed. Furthermore, the robot must send an HF-In message in every GTS allocated to it; should the robot be allocated a GTS for HF\_IN\_MAX\_FAILURES superframes and not send a frame in any of them, the host shall start disassociation procedures for the robot. Finally, should a robot see \(DISASSOCIATE\_SLOW\_MAX\_BEACONS÷4\) beacons without ever being granted a GTS, the robot shall send a start disassociation procedures. The host shall consider an HF-In message received if the packet sequence number is not equal to the last-seen packet sequence number from the sender.

LL-In messages shall be sent as ordinary direct data frames in the contention access period. The Acknowledgement Request bit shall be set. The robot shall report the transmission as successful or failed based on the MAC layer’s status; no extra retransmissions shall be performed. The host shall consider an LL-In message received if the packet sequence number is not equal to the last-seen packet sequence number from the sender.

